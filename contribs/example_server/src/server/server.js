// node imports
import Path from 'path'
import Http from 'http'

// npm imports
import Express from 'express'
import ServeIndex from 'serve-index'
import BodyParser from 'body-parser'
import Cors from 'cors'

// local imports
import ServerApiHackerNews from './api_hackernews.js'
import ServerApiGptActions from './api_gpt_actions.js'

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
//	
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

// NOTE: trick to have __dirname available in ESM modules - https://blog.logrocket.com/alternatives-dirname-node-js-es-modules/#how-does-getting-dirname-back-work
import * as url from 'url';
const __dirname = url.fileURLToPath(new URL('.', import.meta.url))

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
//	
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

const expressApp = Express()

// FIXME is that good ? check this out
expressApp.use(BodyParser.urlencoded({ extended: true }));
expressApp.use(BodyParser.json());
expressApp.use(BodyParser.raw());

// @ts-ignore
const httpServer = Http.createServer(expressApp);
const PORT = process.env.PORT || 3010
httpServer.listen(PORT, () => {
	// console.log(`Example app listening on port ${PORT}`)
	console.log(`Server running at http://localhost:${PORT}/`);
})

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
//	Eneable CORS
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

// needed for the chat-widget - it get called from different domains
expressApp.use(Cors({
	origin: "*"
}))

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
//	
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

// add ServerApiHackerNews
await ServerApiHackerNews.init()
expressApp.use('/api/gpt-hn', ServerApiHackerNews.expressRouter)

// add ServerApiGptActions
await ServerApiGptActions.init()
expressApp.use('/api/gpt-actions', ServerApiGptActions.expressRouter)

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
//	serve static files and directory listing (only for development)
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

// serve static files from ```/web``` folders
const webStaticPath = Path.join(__dirname, '../../web/')
expressApp.use('/', Express.static(webStaticPath))

// enable serving directory listing - only for development
expressApp.use('/', ServeIndex(webStaticPath))

